# [\#15](https://shikumirb.connpass.com/event/370549/)

## やったこと

前回に続き、[kaneko\.y（\@spikeolaf）](https://x.com/spikeolaf) さんが作成された lr-parser-101 を使って、みんなでワイワイしながらパーサを生成しました！

[yui\-knk/lr\-parser\-101](https://github.com/yui-knk/lr-parser-101)

### 第 5 章

第 5 章では括弧を含む四則演算の計算式を受け取って、その計算結果を表示するシンプルなパーサを作る。

今回は括弧を導入する。

#### 括弧の導入

天下り的だが、以下のような文法ルールを書いてみる。

```ruby
rule
  program: expr { p val[0] }
         ;

  expr: term { result = val[0] }
      | expr '+' term { result = val[0] + val[2] }
      ;

  term: primary { result = val[0] }
      | term '*' primary { result = val[0] * val[2] }

  primary: NUMBER { result = val[0] }
         | '(' expr ')' { result = val[1] }
         ;
end
```

これは数学の**多項式**（expr に相当）と**単項式**（term に相当）の定義を BNF で表したものと解釈できそう。

`racc` を利用してパーサを生成する。Rakefile にパーサを生成するためのコマンドが記載されているので、ここではそのコマンドを直接実行してみる。

```sh
❯ cat Rakefile 
task default: :compile

task :compile do
  puts "Compiling parser ..."

  `racc calc.y -o calc.rb`
end

❯ ls | grep calc.rb

# Rakefile に記載されているコマンドを実行
❯ racc calc.y -o calc.rb

❯ ls | grep calc.rb     
calc.rb
```

生成されたパーサを実行してみる。

```sh
❯ ruby calc.rb
Enter the formula:
3 + (4 + 5)
12

Enter the formula:
3 + (4 * 5)
23

Enter the formula:
3 * (4 + 5)
27

Enter the formula:
3 * (4 * 5)
60

Enter the formula:
3 + 4 + 5
12

Enter the formula:
3 * 4 * 5
60

Enter the formula:
3 + 4 * 5
23

Enter the formula:
q
Bye!
```

確かに括弧を含む計算式の結果が正しく表示される。
