# [\#17](https://shikumirb.connpass.com/event/374008/)

## やったこと

「Ruby のしくみ」をみんなでワイワイ言いながら読み進めました！

[Rubyのしくみ　Ruby Under a Microscope【委託】 \- 達人出版会](https://tatsu-zine.com/books/ruby-under-a-microscope-ja)

### Ruby のバージョン

以下では、Ruby のバージョン 3.4.5 を利用している。

```sh
❯ ruby -v
ruby 3.4.5 (2025-07-16 revision 20cda200d3) +PRISM [x86_64-darwin22]
```

### AST の出力

`ruby` コマンドに `--dump=parsetree` オプションを付与すると、AST を出力することができる。

```sh
❯ cat script.rb                  
puts 2 + 3

❯ ruby --parser=parse.y --dump=parsetree script.rb
###########################################################
## Do NOT use this node dump for any purpose other than  ##
## debug and research.  Compatibility is not guaranteed. ##
###########################################################

# @ NODE_SCOPE (id: 6, line: 1, location: (1,0)-(1,10))
# +- nd_tbl: (empty)
# +- nd_args:
# |   (null node)
# +- nd_body:
#     @ NODE_FCALL (id: 1, line: 1, location: (1,0)-(1,10))*
#     +- nd_mid: :puts
#     +- nd_args:
#         @ NODE_LIST (id: 5, line: 1, location: (1,5)-(1,10))
#         +- as.nd_alen: 1
#         +- nd_head:
#         |   @ NODE_OPCALL (id: 4, line: 1, location: (1,5)-(1,10))
#         |   +- nd_mid: :+
#         |   +- nd_recv:
#         |   |   @ NODE_INTEGER (id: 0, line: 1, location: (1,5)-(1,6))
#         |   |   +- val: 2
#         |   +- nd_args:
#         |       @ NODE_LIST (id: 3, line: 1, location: (1,9)-(1,10))
#         |       +- as.nd_alen: 1
#         |       +- nd_head:
#         |       |   @ NODE_INTEGER (id: 2, line: 1, location: (1,9)-(1,10))
#         |       |   +- val: 3
#         |       +- nd_next:
#         |           (null node)
#         +- nd_next:
#             (null node)
```

これは以下のような木構造を表していると見做せる。（レシーバを左の子、引数を右の子として表現）

```
  puts
    \
     +
    / \
   2   3
```

### YARV 命令列の出力

`ruby` コマンドに `--dump=insns` オプションを付与すると、YARV 命令列を出力することができる。

```sh
❯ ruby --parser=parse.y --dump=insns script.rb
== disasm: #<ISeq:<main>@script.rb:1 (1,0)-(1,10)>
0000 putself                                                          (   1)[Li]
0001 putobject                              2
0003 putobject                              3
0005 opt_plus                               <calldata!mid:+, argc:1, ARGS_SIMPLE>[CcCr]
0007 opt_send_without_block                 <calldata!mid:puts, argc:1, FCALL|ARGS_SIMPLE>
0009 leave
```

Ruby の処理系は、関数およびメソッド呼び出しを以下の命令列にコンパイルする。

1. レシーバを push するための YARV 命令
1. 引数を push するための YARV 命令
1. メソッド/関数呼び出しを表す YARV 命令

実際に上の出力結果を見ると、確かに AST を**深さ優先**で探索しながら（基本的には）**帰りがけ順**で YARV 命令列を作っているように見える。

```
  puts
    \
     +
    / \
   2   3
```

1. `puts` は左の子ノード（つまりレシーバ）がいないので、`putself` という YARV 命令を生成
1. `puts` の右の子ノード（つまり引数）である `+` に移動
1. `+` の左の子ノード（つまりレシーバ）である `2` に移動
1. `2` は子ノードがいないので、`putobject 2` という YARV 命令を生成
1. `+` の右の子ノード（つまり引数）である `3` に移動
1. `3` は子ノードがいないので、`putobject 3` という YARV 命令を生成
1. `+` は未探索の子ノードがいないので、`opt_plus <callinfo!mid:+, argc:1, ...>` という YARV 命令を生成
1. `puts` は未探索の子ノードがいないので、`opt_send_without_block <callinfo!mid:puts, argc:1, ...>` という YARV 命令を生成
