# [\#12](https://shikumirb.connpass.com/event/365643/)

## やったこと

前回に続き、[kaneko\.y（\@spikeolaf）](https://x.com/spikeolaf) さんが作成された lr-parser-101 を使って、みんなでワイワイしながらパーサを生成しました！

[yui\-knk/lr\-parser\-101](https://github.com/yui-knk/lr-parser-101)

### 第 2 章

第 2 章では足し算と引き算の計算式を受け取って、その計算結果を表示するシンプルなパーサを作る。

今回は引き算を実装する。

#### 引き算の実装

`parse` メソッドが手書き Lexer の役割を担っていて、入力された文字列をスキャンしていき以下のようにトークンを生成している。

| スキャンされた文字列 | トークンの記号 | トークンの意味値 |
| :--- | :--- | :--- |
| 数字 | `:NUMBER` | Integer に変換した値 |
| `+` | `'+'` | `'+'` |
| `-` | `'-'` | `'-'` |

```ruby
  def parse(str)
    @q = []
    ss = StringScanner.new(str)

    while !ss.eos? do
      case
      when ss.scan(/\s+/)
        # skip spaces
      when ss.scan(/(\d+)/)
        @q << [:NUMBER, ss[0].to_i]
      when ss.scan(/\+/)
        @q << ['+', '+']
      when ss.scan(/\-/)
        @q << ['-', '-']
```

足し算と引き算の計算式を受け取って、その計算結果を表示するパーサを作るための BNF は以下のように書けそう。

```ruby
rule
  program: NUMBER '+' NUMBER { p val[0] + val[2] }
         | NUMBER '-' NUMBER { p val[0] - val[2] }
         | NUMBER { p val[0] }
```

`racc` を利用してパーサを生成する。Rakefile にパーサを生成するためのコマンドが記載されているので確認する。

```sh
❯ cat Rakefile | grep racc
  `racc calc.y -o calc.rb`
```

ここではこのコマンドを直接実行してみる。

```sh
❯ ls | grep calc.rb

❯ racc calc.y -o calc.rb

❯ ls | grep calc.rb     
calc.rb
```

生成されたパーサを実行してみる。

```sh
❯ ruby calc.rb
Enter the formula:
1 + 2
3

Enter the formula:
3 - 4
-1

Enter the formula:
10 
10

Enter the formula:
q
Bye!
```

確かに足し算と引き算の結果が表示される。

### 第 3 章

2 章までのパーサでは `1 + 2 + 3` のような計算ができない。

3 章では複数回の足し算や引き算が実行できるようにする。

#### 複数回の足し算

天下り的だが、BNF を以下のように書き換えてみる。（見やすくするため、引き算に関する BNF は消している）

`result` という変数を使って子から親に意味値を渡しているのがポイント。 

```ruby
rule
  program: exp { p val[0] }
         ;

  exp: NUMBER { result = val[0] }
     | exp '+' NUMBER { result = val[0] + val[2] }
     ;
end
```

`racc` を利用してパーサを生成する。

```sh
❯ ls | grep calc.rb   

❯ racc calc.y -o calc.rb

❯ ls | grep calc.rb     
calc.rb
```

生成されたパーサを実行してみる。

```sh
❯ ruby calc.rb
Enter the formula:
1 + 2 
3

Enter the formula:
3 + 4 + 5
12

Enter the formula:
6 + 7 + 8 + 9
30

Enter the formula:
q
Bye!
```

確かに複数回の足し算の結果が正しく表示される。
