# [\#13](https://shikumirb.connpass.com/event/367912/)

## やったこと

前回に続き、[kaneko\.y（\@spikeolaf）](https://x.com/spikeolaf) さんが作成された lr-parser-101 を使って、みんなでワイワイしながらパーサを生成しました！

[yui\-knk/lr\-parser\-101](https://github.com/yui-knk/lr-parser-101)

### 第 3 章

2 章までのパーサでは `1 + 2 + 3` のような計算ができない。

3 章では複数回の足し算や引き算が実行できるようにする。

前回は複数回の足し算を実行できるようにしたので、今回は複数回の引き算から。

#### 複数回の引き算

足し算とほとんど同じ文法ルールを 1 行追記するだけで良さそう。

```ruby
rule
  program: expr { p val[0] }
         ;

  expr: NUMBER { result = val[0] }
      | expr '+' NUMBER { result = val[0] + val[2] }
      | expr '-' NUMBER { result = val[0] - val[2] } # この行を追加
      ;
end
```

`racc` を利用してパーサを生成する。Rakefile にパーサを生成するためのコマンドが記載されているので、ここではそのコマンドを直接実行してみる。

```sh
❯ cat Rakefile 
task default: :compile

task :compile do
  puts "Compiling parser ..."

  `racc calc.y -o calc.rb`
end

❯ ls | grep calc.rb

# Rakefile に記載されているコマンドを実行
❯ racc calc.y -o calc.rb

❯ ls | grep calc.rb     
calc.rb
```

生成されたパーサを実行してみる。

```sh
❯ ruby calc.rb
Enter the formula:
1 + 2 + 3
6

Enter the formula:
1 - 2 - 3
-4

Enter the formula:
q
Bye!
```

確かに複数回の足し算、引き算の結果が正しく表示される。

### 第 4 章

第 4 章では四則演算の計算式を受け取って、その計算結果を表示するシンプルなパーサを作る。

今回は掛け算を実装する。

#### 掛け算の実装

足し算とほとんど同じ文法ルールを 1 行追記するだけで良さそうに思える。（見やすくするために、一旦引き算の文法ルールを削除している）

```ruby
rule
  program: expr { p val[0] }
         ;

  expr: NUMBER { result = val[0] }
      | expr '+' NUMBER { result = val[0] + val[2] }
      | expr '*' NUMBER { result = val[0] * val[2] } # この行を追加
      ;
end
```

`racc` を利用してパーサを生成する。Rakefile にパーサを生成するためのコマンドが記載されているので、ここではそのコマンドを直接実行してみる。

```sh
❯ cat Rakefile 
task default: :compile

task :compile do
  puts "Compiling parser ..."

  `racc calc.y -o calc.rb`
end

❯ ls | grep calc.rb

# Rakefile に記載されているコマンドを実行
❯ racc calc.y -o calc.rb

❯ ls | grep calc.rb     
calc.rb
```

生成されたパーサを実行してみる。

```sh
❯ ruby calc.rb
Enter the formula:
2 * 3 * 4
24

Enter the formula:
2 * 3 + 4
10

Enter the formula:
2 + 3 * 4
20

Enter the formula:
q
Bye!
```

複数回の足し算、掛け算の結果が正しく表示されるように見えるが、`2 + 3 * 4` の結果がおかしい。

（`14` と表示されるべきだが、`20` と表示されてしまっている）

恐らく `(2 + 3) * 4`のように足し算が先に計算されてしまっている模様。

演算子の優先順位が正しくなるように文法ルールを修正する必要がある。
