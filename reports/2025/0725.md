# [\#10](https://shikumirb.connpass.com/event/363273/)

## ã‚„ã£ãŸã“ã¨

utsubo ã•ã‚“ã® Cosense ã®è¨˜äº‹ã‚’ã‚‚ã¨ã«ã€ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’å‡ºåŠ›ã—ãŸã¨ãã«æœ€åˆã«è¡¨ç¤ºã•ã‚Œã‚‹**é‚„å…ƒã«é–¢ã™ã‚‹ãƒ­ã‚°**ï¼ˆ**Reducing stack by rule 1**ï¼‰ã«ã¤ã„ã¦ã¿ã‚“ãªã§ãƒ¯ã‚¤ãƒ¯ã‚¤ã—ãªãŒã‚‰æ·±æ˜ã‚Šã—ã¾ã—ãŸï¼

[ruby \-yã§ãƒ‡ãƒãƒƒã‚°æƒ…å ±å‡ºåŠ›ã—ãŸæ™‚ã«æ¯å›è¡¨ç¤ºã•ã‚Œã‚‹"Reducing stack by rule 1\(line 855\):"ã«ã¤ã„ã¦ \- utsubox](https://scrapbox.io/utsubox/ruby_-y%E3%81%A7%E3%83%87%E3%83%90%E3%83%83%E3%82%B0%E6%83%85%E5%A0%B1%E5%87%BA%E5%8A%9B%E3%81%97%E3%81%9F%E6%99%82%E3%81%AB%E6%AF%8E%E5%9B%9E%E8%A1%A8%E7%A4%BA%E3%81%95%E3%82%8C%E3%82%8B%22Reducing_stack_by_rule_1(line_855):%22%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6)

ãã®å¾Œã€[kaneko\.yï¼ˆ\@spikeolafï¼‰](https://x.com/spikeolaf) ã•ã‚“ãŒä½œæˆã•ã‚ŒãŸ lr-parser-101 ã‚’ä½¿ã£ã¦ã€ã¿ã‚“ãªã§ãƒ¯ã‚¤ãƒ¯ã‚¤ã—ãªãŒã‚‰ãƒ‘ãƒ¼ã‚µã‚’ç”Ÿæˆã—ã¾ã—ãŸï¼

[yui\-knk/lr\-parser\-101](https://github.com/yui-knk/lr-parser-101)

### lr-parser-101 ã®ç¬¬ 1 ç« 

ç¬¬ 1 ç« ã§ã¯æ•°å­—ã‚’ 1 ã¤èª­ã‚“ã§ã€ãã®æ•°å­—ã‚’è¡¨ç¤ºã™ã‚‹ã‚·ãƒ³ãƒ—ãƒ«ãªãƒ‘ãƒ¼ã‚µã‚’ä½œã‚‹ã€‚

ãã®ãŸã‚ã«ã€`sample.y` ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ `calc.y` ã‚’ä½œã‚Šã€ã“ã®ä¸­ã« BNF ã§æ–‡æ³•ãƒ«ãƒ¼ãƒ«ã‚’æ›¸ã„ã¦ã„ãã€‚

ä»Šå›ã¯ä»¥ä¸‹ã®ã‚ˆã†ãªæ–‡æ³•ãƒ«ãƒ¼ãƒ«ã‚’è¨˜è¿°ã—ãŸã ã‘ã€‚

```ruby
class Calc

rule
  program: NUMBER { p result }
         ;

end
```

Rakefile ã®ä¸­èº«ã‚’è¦‹ã¦ã¿ã‚‹ã¨ã€`racc` ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ã„ã‚‹ã ã‘ã€‚

```ruby
task default: :compile

task :compile do
  puts "Compiling parser ..."

  `racc calc.y -o calc.rb`
end
```

ã“ã® `racc` ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã¨ `calc.rb` ãŒç”Ÿæˆã•ã‚Œã‚‹ã€‚

ç”Ÿæˆã•ã‚ŒãŸ `calc.rb` ã‚’å®Ÿè¡Œã—ã¦å‹•ä½œç¢ºèªã—ã¦ã¿ã‚‹ã€‚

```sh
â¯ racc calc.y -o calc.rb

â¯ ruby calc.rb
Enter the formula:
1 
1

Enter the formula:
2
2

Enter the formula:
777
777

Enter the formula:
q
Bye!
```

æ•°å­— ã‚’ 1 ã¤å—ã‘å–ã£ã¦ã€ãã®æ•°å­—ã‚’å‡ºåŠ›ã—ã¦ã„ã‚‹ã‚ˆã†ã«è¦‹ãˆã‚‹ã€‚

ç¬¬ 1 ç« ã¯ã‚¯ãƒªã‚¢ï¼ğŸ‰

ã¡ãªã¿ã«ã€`NUMBER` ã¨ã„ã†ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç”Ÿæˆã—ã¦ã„ã‚‹ç®‡æ‰€ã¯ `calc.y` ã®ä»¥ä¸‹ã®ãƒ¡ã‚½ãƒƒãƒ‰ã€‚

`parse` ãƒ¡ã‚½ãƒƒãƒ‰ãŒ Lexer ã®å½¹å‰²ã‚‚æ‹…ã£ã¦ã„ã¦ã€æ­£è¦è¡¨ç¾ã§æ•°å­—ã«ãƒãƒƒãƒã—ãŸã¨ãã¯ `NUMBER` ã¨ã„ã†ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç”Ÿæˆã—ã¦ãƒˆãƒ¼ã‚¯ãƒ³åˆ—ã« push ã—ã¦ã„ã‚‹ã€‚

```ruby
  def parse(str)
    @q = []
    ss = StringScanner.new(str)

    while !ss.eos? do
      case
      when ss.scan(/\s+/)
        # skip spaces
      when ss.scan(/(\d+)/)
        @q << [:NUMBER, ss[0].to_i] # ã“ã“ã§ NUMBER ã¨ã„ã†ãƒˆãƒ¼ã‚¯ãƒ³ãŒç”Ÿæˆã•ã‚Œã¦ã„ã‚‹
      when ss.scan(/\+/)
        @q << ['+', '+']
      when ss.scan(/\-/)
        @q << ['-', '-']
      when ss.scan(/\*/)
        @q << ['*', '*']
      when ss.scan(/\//)
        @q << ['/', '/']
      when ss.scan(/\(/)
        @q << ['(', '(']
      when ss.scan(/\)/)
        @q << [')', ')']
      else
        raise "Parse error (unknown token): #{ss.string[ss.pos]} (#{ss.string}, #{ss.pos})"
      end
    end

    @q << [false, '$end']

    do_parse
  end
```
